# Sistema de Audio y Síntesis de Voz en NADIR

La capacidad de proporcionar una guía auditiva clara y calmada es un componente fundamental en la arquitectura de NADIR diseñada para asistir a usuarios que pueden encontrarse en estados de alta ansiedad donde la fijación visual en una pantalla resulta difícil o contraproducente. El sistema de audio no funciona simplemente como un lector de texto accesorio sino que actúa como un co-terapeuta virtual cuya voz debe ser capaz de penetrar la niebla cognitiva de una crisis de pánico y anclar al usuario en la realidad inmediata de su respiración. Para lograr esto la implementación técnica prioriza la privacidad la latencia mínima y la independencia de la conectividad a internet basándose exclusivamente en el motor de síntesis de voz nativo del sistema operativo Android.

La elección de utilizar el motor TextToSpeech integrado en lugar de servicios de generación de voz en la nube responde a una decisión de diseño ética y técnica. Desde el punto de vista de la privacidad el procesamiento de los datos de voz directamente en el dispositivo asegura que ninguna información sobre las sesiones del usuario o el contenido de las instrucciones salga de su control. Técnicamente esto elimina la latencia de red garantizando que las instrucciones lleguen al usuario en el instante preciso en que son necesarias sin los retardos que podrían desincronizar la voz de las fases respiratorias o de la vibración háptica. Esta inmediatez es crítica pues una instrucción de exhalar que llega medio segundo tarde puede romper el ritmo de coherencia que se intenta establecer.

La arquitectura del sistema de audio se centraliza en la clase TextToSpeechConnection la cual encapsula toda la complejidad de la API de Android y expone una interfaz limpia y suspendida para el resto de la aplicación. Esta clase se instancia como un componente único o Singleton dentro del grafo de inyección de dependencias de Koin asegurando una gestión eficiente de los recursos del sistema. Durante la inicialización del servicio se configura explícitamente el idioma a español de España forzando esta configuración para garantizar la consistencia en la pronunciación y el acento independientemente de la configuración regional del dispositivo del usuario. Esta decisión busca ofrecer una experiencia uniforme y evitar situaciones donde una voz sintetizada con un acento inesperado pudiera resultar distractora.

Un aspecto distintivo de la implementación en NADIR es la estrategia de sincronización temporal entre la voz y el flujo de la aplicación. En lugar de depender de los complejos y a veces inestables callbacks de progreso del motor de TTS nativo conocidos como UtteranceProgressListener se ha optado por un enfoque basado en corrutinas y estimación heurística. Al enviar una instrucción de voz la función speak calcula dinámicamente la duración probable del audio basándose en la longitud del texto a sintetizar. La fórmula utilizada asigna un tiempo base por carácter y establece un umbral mínimo de dos segundos para evitar que frases muy cortas terminen prematuramente desde la perspectiva del flujo de control.

Esta función speak está diseñada como una función de suspensión que introduce un retardo no bloqueante equivalente a la duración estimada del discurso. Esto permite que el ciclo de respiración espere de manera natural a que termine la instrucción verbal antes de proceder o transicionar de estado creando una cadencia conversacional fluida en lugar de una superposición caótica de sonidos. Este mecanismo simplifica drásticamente la lógica de control evitando condiciones de carrera donde la aplicación intenta hablar sobre sí misma y asegurando que cada mensaje tenga su espacio temporal reservado para ser procesado cognitivamente por el usuario.

El manejo de la cola de reproducción es otro punto donde la implementación prioriza la relevancia inmediata sobre la completitud secuencial. Al emitir una nueva instrucción se utiliza el modo QUEUE_FLUSH lo que significa que cualquier mensaje que se estuviera reproduciendo o estuviera en espera es descartado inmediatamente en favor del nuevo contenido. En un contexto de guía de crisis esto es vital ya que si el estado del usuario cambia o si se pasa a una nueva fase respiratoria las instrucciones anteriores pierden su validez instantáneamente. El sistema asegura así que el usuario siempre escuche la instrucción que corresponde al momento presente evitando la confusión que generaría recibir indicaciones desactualizadas.

Aunque la implementación actual utiliza los parámetros de velocidad y tono predeterminados del motor del sistema la arquitectura está preparada para permitir ajustes finos en el futuro. La estructura modular de TextToSpeechConnection permitiría introducir configuraciones personalizadas para alterar la prosodia de la voz haciéndola más lenta y grave para inducir relajación o más firme y rápida para captar la atención durante una disociación severa. Por ahora la confianza en los valores por defecto del sistema garantiza una compatibilidad máxima con la vasta diversidad de motores TTS instalados por los diferentes fabricantes de dispositivos Android.

La robustez del sistema también se manifiesta en su gestión del ciclo de vida. Los métodos de limpieza y apagado aseguran que el motor de síntesis de voz se libere correctamente cuando la aplicación se cierra o el servicio se destruye previniendo fugas de memoria y comportamientos anómalos en el sistema de audio del teléfono. Además se incluyen guardas de seguridad que impiden intentos de reproducción si el motor no ha sido inicializado correctamente o si el texto proporcionado está vacío manejando estos casos de borde de manera silenciosa para no interrumpir la experiencia del usuario con errores técnicos.

En resumen el subsistema de audio de NADIR es un ejemplo de ingeniería pragmática aplicada a un problema clínico. Al evitar la complejidad innecesaria y centrarse en la fiabilidad y la sincronización a través de corrutinas se logra una herramienta de guía verbal que es a la vez robusta y respetuosa con la privacidad del usuario. La voz sintetizada se convierte así en un hilo conductor fiable que teje las instrucciones terapéuticas en el tejido de la experiencia sensorial ayudando al usuario a navegar desde el caos del pánico hacia la calma de la respiración controlada.
